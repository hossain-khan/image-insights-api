# =============================================================================
# Image Insights API - Docker Compose Configuration
# =============================================================================
# A lightweight REST API for image brightness analysis using Rec. 709 luminance.
#
# Repository: https://github.com/hossain-khan/image-insights-api
# Documentation: https://github.com/hossain-khan/image-insights-api/blob/main/docs/API_DOC.md
# Docker Image: https://github.com/hossain-khan/image-insights-api/pkgs/container/image-insights-api
#
# Quick Start:
#   docker compose up -d
#
# Test the API:
#   curl -X POST http://localhost:8080/v1/image/analysis -F "image=@photo.jpg"
#
# API Documentation (when running):
#   http://localhost:8080/docs
# =============================================================================

version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # Production deployment using pre-built image from GitHub Container Registry
  # ---------------------------------------------------------------------------
  image-insights-api:
    image: ghcr.io/hossain-khan/image-insights-api:latest
    container_name: image-insights-api
    ports:
      - "8080:8080"
    environment:
      - LOG_LEVEL=info
      # Set to 'false' to disable detailed application logging (default: true)
      # - ENABLE_DETAILED_LOGGING=false
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"

  # ---------------------------------------------------------------------------
  # Local development - build from source (uncomment to use)
  # ---------------------------------------------------------------------------
  # image-insights-api-dev:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: image-insights-api-dev
  #   ports:
  #     - "8080:8080"
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 5s

# =============================================================================
# Usage:
# =============================================================================
#
# Production (pre-built image):
#   docker compose up -d
#
# Development (build from source):
#   docker compose up -d --build image-insights-api-dev
#
# View logs:
#   docker compose logs -f image-insights-api
#
# Check status:
#   docker compose ps
#
# Stop:
#   docker compose down
#
# Pull latest and restart:
#   docker compose pull && docker compose up -d
#
# =============================================================================
# API Endpoints:
# =============================================================================
#
# POST /v1/image/analysis    - Analyze image brightness (metrics: brightness, median, histogram)
# GET  /health               - Health check
# GET  /health/ready         - Readiness check
# GET  /docs                 - Interactive API documentation (Swagger UI)
#
# =============================================================================
