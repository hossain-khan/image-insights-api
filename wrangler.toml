# Cloudflare Workers and Containers Configuration
# Documentation: https://developers.cloudflare.com/workers/wrangler/configuration/

# Basic Configuration
name = "image-insights-api"
main = "src/index.ts"
compatibility_date = "2026-02-03"

# Enable deployment to workers.dev
workers_dev = true

# Local development settings
[env.development]
vars = { ENVIRONMENT = "development" }

[env.production]
vars = { ENVIRONMENT = "production" }

# Container Configuration
# Runs the Image Insights API as a Cloudflare Container
[[containers]]
image = "./Dockerfile"
class_name = "ImageInsightsContainer"
instance_type = "basic"  # 1/4 vCPU, 1 GiB RAM, 4 GB disk - suitable for image processing
max_instances = 10  # Maximum concurrent container instances

# Durable Objects Configuration
# Container instances are backed by Durable Objects
[durable_objects]
bindings = [
  { name = "IMAGE_INSIGHTS_CONTAINER", class_name = "ImageInsightsContainer" }
]

# Required migration for container-enabled Durable Objects
[[migrations]]
tag = "v1"
new_sqlite_classes = ["ImageInsightsContainer"]

# Development server settings
[env.development.dev]
ip = "localhost"
port = 8787
local_protocol = "http"
enable_containers = true

# Observability - Enable logs for production monitoring
observability = { enabled = true }

# Node.js compatibility for container runtime
compatibility_flags = ["nodejs_compat_v2"]
